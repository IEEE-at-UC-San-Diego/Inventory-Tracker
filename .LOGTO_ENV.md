# Logto Environment Variables

This application uses Logto as the authentication provider. You need to configure the following environment variables:

## Frontend Environment Variables (.env.local)

```bash
# Logto Configuration
VITE_LOGTO_ENDPOINT=https://your-logto-endpoint.logto.app
VITE_LOGTO_APP_ID=your-app-id
VITE_LOGTO_SCOPES=openid,profile,email,offline_access
VITE_LOGTO_RESOURCES=  # Optional: API resource identifiers

# Convex Configuration
VITE_CONVEX_URL=https://your-deployment.convex.cloud
```

## Logto Admin Console Configuration

### 1. Create an Application

1. Go to your Logto Admin Console
2. Navigate to "Applications" → "Create application"
3. Select "Single Page App" (SPA)
4. Enter your application name
5. Configure the following:
   - **Redirect URIs**: Add `http://localhost:3000/callback` for development, and your production callback URL
   - **Post Sign-out Redirect URIs**: Add `http://localhost:3000/` for development

### 2. Configure Custom Claims (Optional for Role Syncing)

To sync user roles from Logto to your application:

1. Go to "Authorization" → "Custom JWT Claims"
2. Create a new custom claim:
   - **Claim name**: `roles`
   - **Claim type**: Array of strings
   - **Script**: Configure to return user roles based on Logto role assignments

Example JavaScript for roles:
```javascript
// Return user roles from Logto's role assignments
const roles = user.roleAssignments.map(ra => ra.role.name);
return roles;
```

3. Create another custom claim for organization (if using Logto Organizations):
   - **Claim name**: `organization_id`
   - **Claim type**: String
   - **Script**:
```javascript
// Return the user's primary organization ID
const organization = user.organizations?.[0];
return organization?.id;
```

### 3. Configure API Resources (Optional)

If you want to access protected APIs with specific scopes:

1. Go to "Authorization" → "API Resources"
2. Create a new API resource:
   - **Identifier**: `urn:inventory-tracker:api`
   - **Name**: Inventory Tracker API
3. Add permissions (scopes):
   - `read:inventory`
   - `write:inventory`
4. Assign these permissions to user roles

### 4. Configure Webhooks (Optional for Real-time Sync)

To sync user updates from Logto to Convex in real-time:

1. Go to "Integrations" → "Webhooks"
2. Create a new webhook:
   - **Webhook URL**: `https://your-convex-deployment.convex.cloud/api/auth/logtoWebhook`
   - **Secret**: Generate a webhook secret for signature verification
   - **Copy the signing key** from the webhook details page
3. Select events to subscribe to:
   - `user.created`
   - `user.updated`
   - `user.deleted`

### 5. Set Environment Variables for Webhook Security

Add the webhook signing key to your environment variables:

```bash
# Frontend (.env) or Backend (.env.local)
LOGTO_WEBHOOK_SIGNING_KEY=your-copied-signing-key-from-logto-webhook
```

**Important**: In production, the webhook signature validation is enforced. Requests without valid signatures will be rejected with a 401 error.

## Development Mode

The application includes development mode login buttons that allow testing different user roles without Logto:

- **Viewer**: Read-only access
- **Editor**: Can edit inventory
- **Admin**: Full access

## Migration Notes

When migrating from Stack Auth/Better Auth to Logto:

1. **User data**: Existing users will need to re-authenticate through Logto. The `logtoUserId` field in the `users` table will be populated with the new Logto subject ID.

2. **Roles**: Configure role syncing in Logto's custom claims to maintain role assignments.

3. **Organizations**: If using Logto Organizations, configure organization_id custom claim to sync orgs.

4. **Session storage**: Logto uses OIDC standard tokens. No session tables are needed as auth is stateless JWT-based.
